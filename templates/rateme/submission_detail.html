{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Morph Faces</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            font-family: Monospace;
            font-size: 13px;
            text-align: center;
            font-weight: bold;

            background-color: #444444;
            margin: 0px;
            overflow: hidden;
        }
    </style>
    <script type="text/javascript" src="{% static 'js/jquery-1.11.1.min.js' %}"></script>
    <script src="{% static 'js/three.min.js' %}"></script>
    <script src="{% static 'averagefaces/js/controls/OrbitControls.js' %}"></script>
    <script src="{% static 'js/msgpack.min.js' %}"></script>

    <script type="text/javascript" src="{% static 'js/math.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery-1.11.1.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/msgpack.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootstrap.min.js' %}"></script>

    <script type="text/javascript" src="{% static 'js/three.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/3dview/OrbitControls.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/3dview/3dview.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/3dview/pca_model.js' %}"></script>
    <script>
        var examples = [
            {
                result: {
                    images: [{
                        original: "{% static 'img/beautyisdataful/examples/0_1.jpg' %}",
                        results: {
                            "indexs": [2861, 2851, 2841, 2824, 2830, 2852, 2862, 2842, 4133, 4130, 4126, 4122, 4109, 4105, 4101, 4093, 4088, 4074, 4076, 4065, 4055, 4043, 4032, 4014, 3998, 3968, 3929, 3888, 3871, 3837, 3783, 3754, 3725, 3673, 3625, 3582, 3552, 3520, 3512, 3494, 3480, 3473, 3460, 3456, 3446, 3443, 3436, 3432, 3424, 3423, 3412, 3411, 3407, 3406, 3402, 2675, 2699, 2697, 2686, 2674, 2667, 2659, 2901, 2904, 2910, 2922, 2936, 2966, 3003, 3011, 3125, 3131, 3137, 3147, 3161, 3170, 3285, 3332, 3368, 3379, 3383, 3384, 2866, 495, 1337, 2193, 1309, 2915, 2990, 3071, 3243, 3318, 3361, 114, 669, 1945, 2483, 1285, 765, 1334],
                            "rating": 6.88850218215887,
                            "facefeatures": {{ submission.images.first.face_processings.first.shape_coefficients }},
                            "new_facefeatures": [-1.431121852934844, 1.1126691977230159, -2.0887804971878037, -0.8110619077721224, -0.7513152506301338, 1.3897893483607913, 1.4353590487153347, -1.0977209941953565, -0.264950052929932, -1.4637966013553505, -0.9190622888436402, 0.054254460129567646, -1.094208236983354, -0.9812167431783564, -2.4694724818051936, 0.48788718017839106, 1.6007508357403708, 0.6244047588983199, -1.102931418108256, 0.19814968136016797, 0.5518528128723794, -0.604129749586924, 0.7812240742421942, -0.7658892636175262, 1.3205736075645262, -0.5971614217988214, -0.08533809295054029, -0.6138368255256162, -1.6275867492297942, -0.6856078093105886, 0.15862144655475174, -1.0289318405701215, -1.002857140435346, 0.10198323585899716, -0.16632038744329497, -0.3265491255770879, 0.09361427383311932, 0.230848951308703, 0.6682641482663813, -0.43027697564766515, 1.036158575442184, -0.6530810282292594, -0.6171389352527663, 0.958441941602601, 0.24992964371625775, 0.009170431916451373, -0.6997018021755276, 0.10692272039069213, -0.7082489029264519, -0.11639621058133869, -1.4804020900791643, -0.5699281160850561, 2.1436961418091354, -1.3674519472146263, 2.0770486237843504, 1.1351291909691967, 0.0048225252217787215, -0.701925226947702, -0.058542490651349983, 0.9981618836928764, 0.35767238693373893, 0.29636314436324723, 0.9675295184212239, -0.5307058127909831, 0.3811949697257221, 0.19456943700980975, -0.8438265353453435, 0.7120353374703818, -0.4228640117597488, 0.3477629646576061, 0.9244129847127541, -0.24508575201438157, 0.4947963447970489, -0.724578827076596, -0.09839189073449607, -0.5272722184444614, -0.8115477127690996, 0.5128630686681528, 2.018784296725557, 0.26718566308382014, -0.5774004179925224, 0.8176001494197804, -0.8087405711736032, 0.562848954300599, 1.5390231075115537, -1.6962185065363928, -0.2414221478680211, -0.47033168164889544, 0.17463570558556876, -0.13128294043059976, 0.359873614026259, -0.08487307984295128, 1.2646322102545944, -1.6795999153601493, 0.551788052972491, -0.10998850415446652, 0.11818424676895248, 0.9428172376018488, -0.07661417117762319],
                            "modelview": [[0.9984882473945618, -0.04306723177433014, -0.034152597188949585, 93.10059356689453], [0.042915813624858856, 0.9990653991699219, -0.005154607817530632, 92.98694610595703], [0.03434266895055771, 0.0036811288446187973, 0.9994033575057983, 0.0], [0.0, 0.0, 0.0, 1.0]],
                            "projection": [[0.01127040944993496, 0.0, 0.0, -1.0], [0.0, 0.009157207794487476, 0.0, -1.0], [0.0, 0.0, -1.0, 0.0], [0.0, 0.0, 0.0, 1.0]],
                            "viewport": [0, 300, 248, -256]
                        }
                    }]
                }
            },
        ];

        function checkAndDisplayResults(data, retryCount) {
            if (retryCount === undefined) {
                retryCount = 0;
            }

            $("#resultsmodal").modal("show");
            if (data.hasOwnProperty("result")) {
                $('#originalImages').html("");
                $('#improvedImages').html("");
                allRatings = [];
//        data.result.images.sort(function(a, b){return b.rating-a.rating});
//            for (var i=0; i<data.result.images.length; i++)
                var i = 0;
                var imageData = data.result.images[i].results;

                var modelview = imageData.modelview;
                var projection = imageData.projection;
                var viewport = imageData.viewport;
                var indexs = imageData.indexs;
                var facefeatures = imageData.facefeatures;
                var new_facefeatures = imageData.new_facefeatures;

                setRenderParams(modelview, projection, viewport, indexs, facefeatures, new_facefeatures);

                //create original image
                var orig = $("<img>");
                orig.attr("src", resizedImages[i].dataUrl);
                orig.addClass("img-responsive");
                orig.appendTo('#originalImages');

                //add the ratings to the array
                allRatings.push(imageData.rating);
//            }

                //set the rating
                $("#rating").html(parseFloat(allRatings[0]).toFixed(2));

                $("#resultswaiting").hide();
                $("#resultserror").hide();
                $("#resultssucessful").show();
            } else {
                displayWaitingModal();
                if (retryCount < 10) {
                    setTimeout(function () {
                        $.ajax({
                            type: "GET",
                            url: "{% url 'api_GetResults' %}",
                            cache: false,
                            data: {
                                taskId: data.taskId,
                                type: "1"
                            },
                            success: function (data) {
                                if (data.status == "FAILURE") {
                                    displayErrorModal(data.error);
                                } else {
                                    checkAndDisplayResults(data, retryCount + 1);
                                }
                            },
                            error: function (data) {
                                displayErrorModal(data.statusText + "\n" + data.responseText.split("\n\n")[0]);
                            }
                        });
                    }, 500 * (retryCount + 1));
                } else {
                    displayErrorModal("We were waiting too long, request timed out");
                }
            }
        }

        function displayWaitingModal(message) {
            $("#resultsmodal").modal("show");
            $("#resultswaiting").show();
            $("#resultserror").hide();
            $("#resultssucessful").hide();
            $("#resultserrorreason").html(message);
        }

        function displayErrorModal(message) {
            $("#resultsmodal").modal("show");
            $("#resultswaiting").hide();
            $("#resultserror").show();
            $("#resultssucessful").hide();
            $("#resultserrorreason").html(message);
        }

        function waitThenSubmitImages(imageselect) {
            if (resizedImages.length == imageselect.files.length) {
                var data = new FormData($("#uploadform")[0]);

                for (var i = 0; i < resizedImages.length; i++) {
                    if (browser.name.includes("Edge") || browser.name.includes("IE")) {
                        data.append("images", dataURLToBlob(resizedImages[i].dataUrl));
                    } else {
                        var resizedImage = new File([dataURLToBlob(resizedImages[i].dataUrl)], resizedImages[i].filename);
                        data.append("images", resizedImage);
                    }
                }
                displayWaitingModal();

                var i = 0;
                PCAModelInit("{% static 'model/bfm_small.msg' %}", resizedImages[i].dataUrl);

                $.ajax({
                    url: "{% url 'upload' %}",
                    data: data,
                    cache: false,
                    contentType: false,
                    processData: false,
                    type: 'POST',
                    success: function (data) {
                        checkAndDisplayResults(data);
                    },
                    error: function (data) {
                        alert("There was an error uploading images");
                    }
                });

                //clear imageselect
                imageselect.value = "";
            }
        }

        function dataURLToBlob(dataURL) {
            var BASE64_MARKER = ';base64,';
            if (dataURL.indexOf(BASE64_MARKER) == -1) {
                var parts = dataURL.split(',');
                var contentType = parts[0].split(':')[1];
                var raw = parts[1];

                return new Blob([raw], {type: contentType});
            }

            var parts = dataURL.split(BASE64_MARKER);
            var contentType = parts[0].split(':')[1];
            var raw = window.atob(parts[1]);
            var rawLength = raw.length;

            var uInt8Array = new Uint8Array(rawLength);

            for (var i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }

            return new Blob([uInt8Array], {type: contentType});
        }

        function correctImagesAndUpload(imageselect) {
            for (var i = 0; i < imageselect.files.length; i++) {
                var file = imageselect.files[i];

                // Ensure it's an image
                if (file.type.match(/image.*/)) {

                    //ensure image is correct orientation and max size, handling safaris weird behavior
                    if (browser.name.includes("Safari")) {
                        canvasResize(file, {
                            width: 512,
                            height: 0,
                            crop: false,
                            quality: 80,
                            callback: function (data, width, height) {
                                resizedImages.push({"filename": file.name, "dataUrl": data});
                                waitThenSubmitImages(imageselect);
                            }
                        });

                    } else {
                        loadImage(
                            file,
                            function (canvas) {
                                var dataUrl = canvas.toDataURL('image/jpeg');

                                resizedImages.push({"filename": file.name, "dataUrl": dataUrl});

                                waitThenSubmitImages(imageselect);
                            },
                            {
                                maxWidth: 512,
                                maxHeight: 512,
                                orientation: true,
                                canvas: true
                            }
                        );
                    }
                } else {
                    displayErrorModal("The file you uploaded is not an image");
                    return;
                }
            }
        }

        var resizedImages = [];
        $(function () {
            var i = 0;
            var exampleData = examples[i];
            resizedImages = [{dataUrl: exampleData.result.images[0].original}];
            PCAModelInit("{% static 'model/bfm_small.msg' %}", resizedImages[0].dataUrl);
            checkAndDisplayResults(exampleData);
        });
    </script>
</head>
<body>
<div id="3dcanvas" style="width:500px; height:500px"></div>
</body>
</html>